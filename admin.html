<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevate Capital - Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">

    <script>
        // --- Tailwind Configuration (Inherited from Dashboard) ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-navy': '#0C0E17',
                        'card-navy': '#10121B',
                        'primary-gold': '#CBA35A',
                        'secondary-gold': '#D4AF37',
                        'accent-gold-light': '#E6C46A',
                        'text-primary-light': '#E8E3D0',
                        'text-secondary-light': '#A0A0A0',
                        'success-green': '#9ED089',
                        'error-red': '#F28C8C',
                    },
                    fontFamily: {
                        'heading': ['Cinzel', 'serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'card-luxury': '0 4px 16px rgba(0, 0, 0, 0.4)',
                        'gold-glow': '0 0 10px #E6C46A',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="font-body min-h-screen pb-20">
    <script>
        // APPS_SCRIPT_URL and signOut are now in script.js
        // Common authentication check is in script.js, but admin-specific check remains here.
        if (localStorage.getItem('isAuthenticated') !== 'true' || localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>

    <header class="bg-card-navy px-4 py-6 md:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-heading text-3xl font-bold text-secondary-gold tracking-wider">
                    ADMIN PANEL
                </h1>
                <p class="text-text-secondary-light text-sm mt-1">Group Management</p>
            </div>
            <div class="relative">
                <button id="user-menu-button"
                    class="w-10 h-10 bg-primary-gold rounded-full flex items-center justify-center text-deep-navy font-bold text-xl">
                </button>
                <div id="user-menu-dropdown"
                    class="absolute right-0 mt-2 w-48 bg-card-navy rounded-md shadow-lg py-1 z-50 hidden">
                    <div class="px-4 py-2 text-text-primary-light" id="user-menu-email"></div>
                    <a href="#" onclick="signOut()"
                        class="block px-4 py-2 text-sm text-text-primary-light hover:bg-primary-gold/10">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section class="admin-section">
            <h3 class="admin-section-title">Pending Approvals</h3>
            <div id="pendingUsersContainer" class="space-y-3"></div>
            <div id="pendingUsersMessage" class="form-message"></div>
        </section>

        <section class="admin-section">
            <h3 class="admin-section-title">Notifications</h3>
            <form id="notificationForm" class="mb-6">
                <div class="space-y-4">
                    <textarea id="notificationMessage" placeholder="Notification message..." required rows="3"
                        class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus"></textarea>
                    <select id="notificationTarget" required
                        class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <option value="ALL">All Users</option>
                    </select>
                </div>
                <button type="submit"
                    class="w-full mt-4 py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Add
                    Notification</button>
                <div id="notificationFormMessage" class="form-message"></div>
            </form>
            <div id="notificationsContainer" class="space-y-3"></div>
        </section>

        <section class="admin-section">
            <h3 class="admin-section-title">Dashboard Metrics</h3>
            <form id="dashboardMetricsForm" class="form-grid">
                <input type="text" name="Total Return" placeholder="Total Return"
                    class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                <input type="text" name="Expected Return (Next Month)" placeholder="Expected Return (Next Month)"
                    class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                <button type="submit"
                    class="w-full py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Update
                    Manual Metrics</button>
                <button type="button" id="recalculateButton"
                    class="w-full py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Recalculate
                    Auto Metrics</button>
            </form>
            <div id="dashboardMessage" class="form-message"></div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="admin-section">
                <h3 class="admin-section-title">User Management</h3>
                <form id="addUserForm" class="mb-6">
                    <p class="font-semibold text-text-primary-light mb-2">Add New User</p>
                    <div class="space-y-4">
                        <input type="text" id="newName" placeholder="Full Name" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="email" id="newEmail" placeholder="Email" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="password" id="newPassword" placeholder="Password" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                    </div>
                    <button type="submit"
                        class="w-full mt-4 py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Add
                        User</button>
                    <div id="addUserMessage" class="form-message"></div>
                </form>
                <form id="addContributionForm">
                    <p class="font-semibold text-text-primary-light mb-2">Add Contribution</p>
                    <div class="space-y-4">
                        <select id="userSelect" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                            <option value="">Select User...</option>
                        </select>
                        <input type="number" id="contributionAmount" placeholder="Amount" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="date" id="contributionDate" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus"
                            style="color-scheme: dark;">
                        <textarea id="contributionNotes" placeholder="Notes (optional)" rows="2" class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus"></textarea>
                        <div class="flex items-center">
                            <input type="checkbox" id="isMonthlyPayment" class="h-4 w-4 rounded border-gray-300 text-primary-gold focus:ring-primary-gold" style="color-scheme: dark;">
                            <label for="isMonthlyPayment" class="ml-2 block text-sm text-text-primary-light">Is this a monthly payment?</label>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full mt-4 py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Add
                        Contribution</button>
                    <div id="contributionMessage" class="form-message"></div>
                </form>
            </section>

            <section class="admin-section">
                <h3 class="admin-section-title">Portfolio Growth Chart</h3>
                <form id="portfolioHistoryForm">
                    <p id="historyFormTitle" class="font-semibold text-text-primary-light mb-2">Add Chart Data Point</p>
                    <input type="hidden" id="historyAction" value="add">
                    <input type="hidden" id="historyRowIndex" value="">
                    <div class="form-grid">
                        <input type="date" id="historyDate" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus"
                            style="color-scheme: dark;">
                        <input type="number" id="historyValue" placeholder="Total Value" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                    </div>
                    <button type="submit" id="historySubmitButton"
                        class="w-full mt-4 py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Add
                        Chart Data</button>
                    <button type="button" id="cancelHistoryEditButton" onclick="resetHistoryForm()"
                        style="display:none;"
                        class="w-full mt-2 py-2 text-text-secondary-light font-bold border border-text-secondary-light rounded-full hover:bg-text-secondary-light/10">Cancel
                        Edit</button>
                    <div id="historyMessage" class="form-message"></div>
                </form>
                <div id="historyContainer" class="space-y-2 max-h-48 overflow-y-auto mt-4"></div>
            </section>
        </div>

        <section class="admin-section">
            <h3 class="admin-section-title">Portfolio Holdings</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <form id="holdingForm">
                    <p id="holdingFormTitle" class="font-semibold text-text-primary-light mb-2">Add New Holding</p>
                    <input type="hidden" id="holdingAction" value="add">
                    <input type="hidden" id="holdingRowIndex" value="">
                    <div class="space-y-4">
                        <input type="text" id="stockName" placeholder="Stock Name" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="number" id="shares" placeholder="Shares" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="number" id="purchasePrice" placeholder="Purchase Price" step="any" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                        <input type="number" id="currentPrice" placeholder="Current Price" step="any" required
                            class="w-full bg-deep-navy border-b border-primary-gold text-text-primary-light p-2 input-glow-focus">
                    </div>
                    <button type="submit" id="holdingSubmitButton"
                        class="w-full mt-4 py-2 text-secondary-gold font-bold border border-primary-gold rounded-full hover:shadow-gold-glow">Add
                        Holding</button>
                    <button type="button" id="cancelHoldingEditButton" onclick="resetHoldingForm()"
                        style="display:none;"
                        class="w-full mt-2 py-2 text-text-secondary-light font-bold border border-text-secondary-light rounded-full hover:bg-text-secondary-light/10">Cancel
                        Edit</button>
                    <div id="holdingMessage" class="form-message"></div>
                </form>
                <div>
                    <p class="font-semibold text-text-primary-light mb-2">Current Holdings</p>
                    <div id="holdingsContainer" class="space-y-2 max-h-72 overflow-y-auto"></div>
                </div>
            </div>
        </section>

    </main>

    <nav
        class="fixed bottom-0 left-0 right-0 bg-card-navy border-t border-[rgba(203,163,90,0.3)] py-3 px-4 shadow-lg z-50">
        <div class="flex justify-around items-center max-w-lg mx-auto">
            <a href="home.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold font-medium group">
                <img src="assets/home.png" class="icon-md mb-1" alt="assets">
                Home
            </a>
            <a href="portfolio.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold text-xs font-medium group">
                <img src="assets/portfolio.png" class="icon-md mb-1" alt="assets">
                Portfolio
            </a>
            <a href="proofs.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold text-xs font-medium group">
                <img src="assets/proof.png" class="icon-md mb-1" alt="assets">
                Proofs
            </a>
            <a href="group.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold text-xs font-medium group">
                <img src="assets/group.png" class="icon-md mb-1" alt="assets">
                Group
            </a>
            <a href="user.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold text-xs font-medium group">
                <img src="assets/user.png" class="icon-md mb-1" alt="assets">
                User
            </a>
            <a id="admin-link" href="admin.html"
                class="flex flex-col items-center text-text-secondary-light hover:text-primary-gold text-xs font-medium group"
                style="display: none;">
                <img src="./assets/admin.png" class="icon-md mb-1" alt="assets">
                Admin
            </a>
        </div>
    </nav>

    <script>
        const adminEmail = localStorage.getItem('userEmail');
        let allHoldings = [];
        let allHistoryPoints = [];

        function setButtonLoading(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                `;
            } else {
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
            }
        }

        async function handleAdminAction(action, body, messageDiv, button) {
            if (button) setButtonLoading(button, true);
            messageDiv.style.display = 'none';
            messageDiv.classList.remove('text-success-green', 'text-error-red');

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, adminEmail, ...body })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    messageDiv.textContent = result.data.message || 'Success!';
                    messageDiv.classList.add('text-success-green');
                } else { throw new Error(result.message || 'An unknown error occurred.'); }
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.classList.add('text-error-red');
            } finally {
                if (button) setButtonLoading(button, false);
                messageDiv.style.display = 'block';
            }
        }

        // --- Load Initial Data ---
        async function loadInitialData() {
            loadPendingUsers();
            loadMembers();
            loadHoldings();
            loadHistoryPoints();
            loadNotifications();
        }

        async function loadMembers() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?page=members`);
                const result = await response.json();
                if (result.status === 'success') {
                    const userSelect = document.getElementById('userSelect');
                    const notificationTarget = document.getElementById('notificationTarget');

                    // Clear existing options except the first one
                    while (userSelect.options.length > 1) userSelect.remove(1);
                    while (notificationTarget.options.length > 1) notificationTarget.remove(1);

                    result.data.forEach(member => {
                        if (member.Email) {
                            const option = new Option(`${member.Name} (${member.Email})`, member.Email);
                            userSelect.add(option.cloneNode(true));
                            notificationTarget.add(option);
                        }
                    });
                }
            } catch (error) { console.error('Failed to load members:', error); }
        }

        // --- Pending Users Functions ---
        async function loadPendingUsers() {
            const container = document.getElementById('pendingUsersContainer');
            const messageDiv = document.getElementById('pendingUsersMessage');
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?page=getPendingUsers&adminEmail=${encodeURIComponent(adminEmail)}`);
                const result = await response.json();
                container.innerHTML = '';
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'flex flex-wrap justify-between items-center p-3 bg-deep-navy rounded';
                        div.innerHTML = `
                            <div>
                                <p class="text-text-primary-light font-semibold">${user.Name}</p>
                                <p class="text-text-secondary-light text-sm">${user.Email}</p>
                            </div>
                            <div class="flex items-center mt-2 sm:mt-0">
                                <button class="text-success-green hover:text-green-400 text-sm font-bold py-1 px-3 rounded-full border border-success-green mr-2" onclick="approveUser('${user.Email}', this)">Approve</button>
                                <button class="text-error-red hover:text-red-400 text-sm font-bold py-1 px-3 rounded-full border border-error-red" onclick="rejectUser('${user.Email}', this)">Reject</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = `<p class="text-text-secondary-light text-center">No pending user requests.</p>`;
                }
            } catch (error) {
                messageDiv.textContent = 'Failed to load pending users.';
                messageDiv.style.display = 'block';
                console.error('Failed to load pending users:', error);
            }
        }

        async function approveUser(email, button) {
            await handleAdminAction('approveUser', { email }, document.getElementById('pendingUsersMessage'), button);
            loadPendingUsers();
            loadMembers();
        }

        async function rejectUser(email, button) {
            await handleAdminAction('rejectUser', { email }, document.getElementById('pendingUsersMessage'), button);
            loadPendingUsers();
        }

        // --- Notifications Functions ---
        async function loadNotifications() {
            const container = document.getElementById('notificationsContainer');
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?page=getNotificationsAdmin&adminEmail=${encodeURIComponent(adminEmail)}`);
                const result = await response.json();
                container.innerHTML = '';
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(notif => {
                        const div = document.createElement('div');
                        div.className = 'flex flex-wrap justify-between items-center p-3 bg-deep-navy rounded';
                        const target = notif.TargetEmail === 'ALL' ? 'All Users' : notif.TargetEmail;
                        div.innerHTML = `
                            <div>
                                <p class="text-text-primary-light">${notif.Message}</p>
                                <p class="text-text-secondary-light text-sm">Target: ${target}</p>
                            </div>
                            <div class="flex items-center mt-2 sm:mt-0">
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="toggle-${notif.ID}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${notif.IsActive ? 'checked' : ''} onchange="toggleNotification('${notif.ID}', this.checked)"/>
                                    <label for="toggle-${notif.ID}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                                <button class="text-error-red hover:text-red-400 text-xs" onclick="deleteNotification('${notif.ID}')">Delete</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = `<p class="text-text-secondary-light text-center">No notifications found.</p>`;
                }
            } catch (error) { console.error('Failed to load notifications:', error); }
        }

        async function toggleNotification(id, isActive) {
            await handleAdminAction('toggleNotificationStatus', { id, isActive }, document.getElementById('notificationFormMessage'));
            loadNotifications();
        }

        async function deleteNotification(id) {
            if (!confirm('Are you sure you want to delete this notification?')) return;
            await handleAdminAction('deleteNotification', { id }, document.getElementById('notificationFormMessage'));
            loadNotifications();
        }

        // --- Holdings Functions ---
        async function loadHoldings() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?page=portfolio`);
                const result = await response.json();
                const container = document.getElementById('holdingsContainer');
                container.innerHTML = '';
                if (result.status === 'success') {
                    allHoldings = result.data;
                    allHoldings.forEach(holding => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-2 bg-deep-navy rounded';
                        div.innerHTML = `
                            <span class="text-text-primary-light">${holding['Stock Name']}</span>
                            <div>
                                <button class="text-accent-gold-light hover:text-yellow-400 text-xs mr-2" onclick="editHolding(${holding.rowIndex})">Edit</button>
                                <button class="text-error-red hover:text-red-400 text-xs" onclick="deleteHolding('${holding['Stock Name']}')">Delete</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (error) { console.error('Failed to load holdings:', error); }
        }

        function editHolding(rowIndex) {
            const holding = allHoldings.find(h => h.rowIndex === rowIndex);
            if (!holding) return;
            document.getElementById('holdingFormTitle').textContent = 'Edit Holding';
            document.getElementById('holdingAction').value = 'update';
            document.getElementById('holdingRowIndex').value = holding.rowIndex;
            document.getElementById('stockName').value = holding['Stock Name'];
            document.getElementById('shares').value = holding['Shares'];
            document.getElementById('purchasePrice').value = holding['Purchase Price'];
            document.getElementById('currentPrice').value = holding['Current Price'];
            document.getElementById('holdingSubmitButton').textContent = 'Update Holding';
            document.getElementById('cancelHoldingEditButton').style.display = 'block';
            document.getElementById('holdingForm').scrollIntoView({ behavior: 'smooth' });
        }

        function resetHoldingForm() {
            document.getElementById('holdingFormTitle').textContent = 'Add New Holding';
            document.getElementById('holdingAction').value = 'add';
            document.getElementById('holdingForm').reset();
            document.getElementById('holdingSubmitButton').textContent = 'Add Holding';
            document.getElementById('cancelHoldingEditButton').style.display = 'none';
        }

        async function deleteHolding(stockName) {
            if (!confirm(`Are you sure you want to delete ${stockName}?`)) return;
            await handleAdminAction('deletePortfolioHolding', { stockName }, document.getElementById('holdingMessage'));
            loadHoldings();
        }

        // --- History Functions ---
        async function loadHistoryPoints() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?page=portfolioHistory`);
                const result = await response.json();
                const container = document.getElementById('historyContainer');
                container.innerHTML = '';
                if (result.status === 'success' && result.data.points) {
                    allHistoryPoints = result.data.points;
                    allHistoryPoints.forEach(point => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-2 bg-deep-navy rounded';
                        div.innerHTML = `
                            <span class="text-text-primary-light">${point.date}: ${point.value}</span>
                            <div>
                                <button class="text-accent-gold-light hover:text-yellow-400 text-xs mr-2" onclick="editHistoryPoint(${point.rowIndex})">Edit</button>
                                <button class="text-error-red hover:text-red-400 text-xs" onclick="deleteHistoryPoint(${point.rowIndex})">Delete</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (error) { console.error('Failed to load history points:', error); }
        }

        function editHistoryPoint(rowIndex) {
            const point = allHistoryPoints.find(p => p.rowIndex === rowIndex);
            if (!point) return;
            document.getElementById('historyFormTitle').textContent = 'Edit Chart Data Point';
            document.getElementById('historyAction').value = 'update';
            document.getElementById('historyRowIndex').value = point.rowIndex;
            document.getElementById('historyDate').value = point.date;
            document.getElementById('historyValue').value = point.value;
            document.getElementById('historySubmitButton').textContent = 'Update Data Point';
            document.getElementById('cancelHistoryEditButton').style.display = 'block';
        }

        function resetHistoryForm() {
            document.getElementById('historyFormTitle').textContent = 'Add Chart Data Point';
            document.getElementById('historyAction').value = 'add';
            document.getElementById('portfolioHistoryForm').reset();
            document.getElementById('historySubmitButton').textContent = 'Add Chart Data';
            document.getElementById('cancelHistoryEditButton').style.display = 'none';
        }

        async function deleteHistoryPoint(rowIndex) {
            if (!confirm(`Are you sure you want to delete this chart data point?`)) return;
            await handleAdminAction('deletePortfolioHistory', { rowIndex }, document.getElementById('historyMessage'));
            loadHistoryPoints();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', function () {
            if (localStorage.getItem('isAdmin') === 'true') {
                document.getElementById('admin-link').style.display = 'flex';
            }

            loadInitialData();

            document.getElementById('recalculateButton').addEventListener('click', async (e) => {
                await handleAdminAction('recalculateMetrics', {}, document.getElementById('dashboardMessage'), e.target);
            });

            document.getElementById('dashboardMetricsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const messageDiv = document.getElementById('dashboardMessage');
                const inputs = form.elements;
                
                setButtonLoading(button, true);
                try {
                    for (const input of inputs) {
                        if (input.name && input.value) {
                            // We don't pass the button here to avoid toggling it on each loop
                            await handleAdminAction('updateDashboardMetric', { metricName: input.name, metricValue: input.value }, messageDiv);
                        }
                    }
                } finally {
                    setButtonLoading(button, false);
                    form.reset();
                }
            });

            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const body = {
                    newName: document.getElementById('newName').value,
                    newEmail: document.getElementById('newEmail').value,
                    newPassword: document.getElementById('newPassword').value
                };
                await handleAdminAction('addUser', body, document.getElementById('addUserMessage'), button);
                form.reset();
                loadMembers();
            });

            document.getElementById('addContributionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const body = {
                    userEmail: document.getElementById('userSelect').value,
                    amount: document.getElementById('contributionAmount').value,
                    date: document.getElementById('contributionDate').value,
                    notes: document.getElementById('contributionNotes').value,
                    isMonthly: document.getElementById('isMonthlyPayment').checked
                };
                await handleAdminAction('addUserContribution', body, document.getElementById('contributionMessage'), button);
                form.reset();
            });

            document.getElementById('notificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const body = {
                    message: document.getElementById('notificationMessage').value,
                    targetEmail: document.getElementById('notificationTarget').value
                };
                await handleAdminAction('addNotification', body, document.getElementById('notificationFormMessage'), button);
                form.reset();
                loadNotifications();
            });

            document.getElementById('portfolioHistoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const action = document.getElementById('historyAction').value;
                const messageDiv = document.getElementById('historyMessage');
                const point = { date: document.getElementById('historyDate').value, value: document.getElementById('historyValue').value };

                if (action === 'update') {
                    const rowIndex = document.getElementById('historyRowIndex').value;
                    await handleAdminAction('updatePortfolioHistory', { rowIndex, point }, messageDiv, button);
                } else {
                    await handleAdminAction('addPortfolioHistory', point, messageDiv, button);
                }
                resetHistoryForm();
                loadHistoryPoints();
            });

            document.getElementById('holdingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const action = document.getElementById('holdingAction').value;
                const messageDiv = document.getElementById('holdingMessage');
                const holding = {
                    'Stock Name': document.getElementById('stockName').value,
                    'Shares': document.getElementById('shares').value,
                    'Purchase Price': document.getElementById('purchasePrice').value,
                    'Current Price': document.getElementById('currentPrice').value,
                };

                if (action === 'update') {
                    const rowIndex = document.getElementById('holdingRowIndex').value;
                    await handleAdminAction('updatePortfolioHolding', { rowIndex, holding }, messageDiv, button);
                } else {
                    await handleAdminAction('addPortfolioHolding', { holding }, messageDiv, button);
                }
                resetHoldingForm();
                loadHoldings();
            });
        });
    </script>

    <script>
        // User menu setup is now in script.js
    </script>
    <script src="script.js"></script>
</body>

</html>